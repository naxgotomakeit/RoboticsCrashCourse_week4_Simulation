from controller import Robot, DistanceSensor, Motor, PositionSensor, Accelerometer, Camera

# --- constants (same as C version) ---
WHEEL_RADIUS = 0.02
AXLE_LENGTH = 0.052
RANGE = 1024 / 2  # 512

BRAITENBERG = [
    [0.942, -0.22],
    [0.63,  -0.10],
    [0.50,  -0.06],
    [-0.06, -0.06],
    [-0.06, -0.06],
    [-0.06,  0.50],
    [-0.19,  0.63],
    [-0.13,  0.942],
]

def compute_odometry(left_ps: PositionSensor, right_ps: PositionSensor):
    l = left_ps.getValue()   # wheel angle (rad)
    r = right_ps.getValue()
    dl = l * WHEEL_RADIUS    # meters
    dr = r * WHEEL_RADIUS
    da = (dr - dl) / AXLE_LENGTH
    print(f"estimated distance covered by left wheel: {dl:g} m.")
    print(f"estimated distance covered by right wheel: {dr:g} m.")
    print(f"estimated change of orientation: {da:g} rad.")

def clamp(x, lo, hi):
    return max(lo, min(hi, x))

# --- 1) init robot ---
robot = Robot()
model = robot.getModel()

if model == "GCtronic e-puck2":
    print("e-puck2 robot")
    TIME_STEP = 64
    CAMERA_TIME_STEP = 64
else:
    print("e-puck robot")
    TIME_STEP = 256
    CAMERA_TIME_STEP = 1024

# --- 2) camera + accelerometer (enabled like C) ---
camera: Camera = robot.getDevice("camera")
camera.enable(CAMERA_TIME_STEP)

accelerometer: Accelerometer = robot.getDevice("accelerometer")
accelerometer.enable(TIME_STEP)

# --- 3) motors (speed control) ---
left_motor: Motor = robot.getDevice("left wheel motor")
right_motor: Motor = robot.getDevice("right wheel motor")
left_motor.setPosition(float("inf"))
right_motor.setPosition(float("inf"))
left_motor.setVelocity(0.0)
right_motor.setVelocity(0.0)

# --- 4) wheel position sensors ---
left_wheel_ps: PositionSensor = robot.getDevice("left wheel sensor")
right_wheel_ps: PositionSensor = robot.getDevice("right wheel sensor")
left_wheel_ps.enable(TIME_STEP)
right_wheel_ps.enable(TIME_STEP)

# --- 5) distance sensors ---
ps_names = [f"ps{i}" for i in range(8)]
ps = []
for name in ps_names:
    s: DistanceSensor = robot.getDevice(name)
    s.enable(TIME_STEP)
    ps.append(s)

# (optional) if you want to limit motor speeds safely:
# e-puck wheels often allow about 6.28 rad/s (depends on robot)
MAX_SPEED = 6.28

# --- 6) main loop ---
while robot.step(TIME_STEP) != -1:
    # read distance sensors
    sensors_value = [s.getValue() for s in ps]

    # accelerometer print (same style as C)
    a = accelerometer.getValues()
    print(f"accelerometer values = {a[0]:0.2f} {a[1]:0.2f} {a[2]:0.2f}")

    # odometry print (same as C)
    compute_odometry(left_wheel_ps, right_wheel_ps)

    # Braitenberg speed compute (same as C)
    speed_left = 0.0
    speed_right = 0.0
    for j in range(8):
        stim = 1.0 - (sensors_value[j] / RANGE)
        speed_left  += BRAITENBERG[j][0] * stim
        speed_right += BRAITENBERG[j][1] * stim

    # clamp (C did not clamp, but this prevents exceeding motor limits)
    speed_left = clamp(speed_left, -MAX_SPEED, MAX_SPEED)
    speed_right = clamp(speed_right, -MAX_SPEED, MAX_SPEED)

    left_motor.setVelocity(speed_left)
    right_motor.setVelocity(speed_right)
